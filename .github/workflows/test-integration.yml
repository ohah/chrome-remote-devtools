name: Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - 'tests/**'
      - '.github/workflows/test-integration.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - 'tests/**'
      - '.github/workflows/test-integration.yml'

jobs:
  check:
    name: Check if should run
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.changes.outputs.integration }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            integration:
              - 'packages/**'
              - 'tests/**'
              - '.github/workflows/test-integration.yml'

  integration-test:
    name: Integration Tests
    needs: check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Skip if no changes
        if: needs.check.outputs.should-run != 'true'
        run: echo "No integration test changes, skipping tests"
        continue-on-error: false

      - name: Setup Bun
        if: needs.check.outputs.should-run == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: needs.check.outputs.should-run == 'true'
        run: bun install

      - name: Install Playwright browsers
        if: needs.check.outputs.should-run == 'true'
        run: bunx playwright install --with-deps chromium

      - name: Build client package
        if: needs.check.outputs.should-run == 'true'
        run: cd packages/client && bun run build

      - name: Run integration tests
        if: needs.check.outputs.should-run == 'true'
        run: bun run test:e2e:integration
        continue-on-error: true
        id: test-run

      - name: Run inspector localStorage isolation test
        if: needs.check.outputs.should-run == 'true'
        run: bunx playwright test tests/e2e/inspector-localstorage-isolation.test.ts --project=chromium
        continue-on-error: true
        id: inspector-test-run

      - name: Publish Test Results
        if: always() && github.event_name == 'pull_request' && needs.check.outputs.should-run == 'true'
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: junit-results.xml
          check_name: Integration Tests
          comment_mode: always
          check_run: false
          report_individual_runs: true
          report_suite_logs: any

      - name: Upload test results
        if: always() && needs.check.outputs.should-run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: failure() && needs.check.outputs.should-run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: test-results/**/*.webm
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test screenshots
        if: always() && needs.check.outputs.should-run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/screenshots/*.png
          retention-days: 30
          if-no-files-found: ignore

      - name: Comment test results on PR
        if: always() && github.event_name == 'pull_request' && needs.check.outputs.should-run == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            const runId = context.runId;
            const repo = context.repo;
            const artifactUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;

            // Find video files / ë¹„ë””ì˜¤ íŒŒì¼ ì°¾ê¸°
            let videoFiles = [];
            try {
              const result = execSync('find test-results -name "*.webm" -type f 2>/dev/null || true', { encoding: 'utf-8' });
              videoFiles = result.trim().split('\n').filter(f => f.length > 0);
            } catch (error) {
              console.log('No video files found');
            }

            // Find screenshot files / ìŠ¤í¬ë¦°ìƒ· íŒŒì¼ ì°¾ê¸°
            let screenshotFiles = [];
            try {
              const result = execSync('find test-results/screenshots -name "*.png" -type f 2>/dev/null || true', { encoding: 'utf-8' });
              screenshotFiles = result.trim().split('\n').filter(f => f.length > 0);
            } catch (error) {
              console.log('No screenshot files found');
            }

            // Always comment if screenshots exist, even if no videos / ìŠ¤í¬ë¦°ìƒ·ì´ ìˆìœ¼ë©´ ë¹„ë””ì˜¤ê°€ ì—†ì–´ë„ ëŒ“ê¸€ ì‘ì„±
            if (screenshotFiles.length === 0 && videoFiles.length === 0) {
              console.log('No test artifacts to comment');
              return;
            }

            // Create comment / ëŒ“ê¸€ ìƒì„±
            let comment = '## ğŸ“Š Test Results\n\n';

            // Add screenshots section / ìŠ¤í¬ë¦°ìƒ· ì„¹ì…˜ ì¶”ê°€
            if (screenshotFiles.length > 0) {
              comment += '### ğŸ“¸ Screenshots\n\n';
              comment += `Screenshots are available as artifacts. [Download them here](${artifactUrl}).\n\n`;
              comment += `**Artifact name:** \`playwright-screenshots\`\n\n`;

              // List screenshot files / ìŠ¤í¬ë¦°ìƒ· íŒŒì¼ ëª©ë¡
              comment += '<details>\n<summary>Screenshot files</summary>\n\n';
              screenshotFiles.forEach((file, index) => {
                const fileName = path.basename(file);
                const clientId = fileName.replace('.png', '');
                comment += `${index + 1}. \`${fileName}\` (${clientId})\n`;
              });
              comment += '\n</details>\n\n';
            }

            // Add videos section / ë¹„ë””ì˜¤ ì„¹ì…˜ ì¶”ê°€
            if (videoFiles.length > 0) {
              comment += '### ğŸ¥ Videos\n\n';
              comment += `Test videos are available as artifacts. [Download them here](${artifactUrl}).\n\n`;
              comment += `**Artifact name:** \`playwright-videos\`\n\n`;

              // List video files / ë¹„ë””ì˜¤ íŒŒì¼ ëª©ë¡
              comment += '<details>\n<summary>Video files</summary>\n\n';
              videoFiles.forEach((file, index) => {
                const fileName = path.basename(file);
                comment += `${index + 1}. \`${fileName}\`\n`;
              });
              comment += '\n</details>\n';
            }

            // Post comment to PR / PRì— ëŒ“ê¸€ ì‘ì„±
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
            });

            // Find existing comment / ê¸°ì¡´ ëŒ“ê¸€ ì°¾ê¸°
            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ğŸ“Š Test Results')
            );

            if (botComment) {
              // Update existing comment / ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              // Create new comment / ìƒˆ ëŒ“ê¸€ ìƒì„±
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

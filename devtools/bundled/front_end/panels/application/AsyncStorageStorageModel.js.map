{"version":3,"file":"AsyncStorageStorageModel.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/AsyncStorageStorageModel.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/*\n * Copyright (C) 2008 Nokia Inc.  All rights reserved.\n * Copyright (C) 2013 Samsung Electronics. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions\n * are met:\n *\n * 1.  Redistributions of source code must retain the above copyright\n *     notice, this list of conditions and the following disclaimer.\n * 2.  Redistributions in binary form must reproduce the above copyright\n *     notice, this list of conditions and the following disclaimer in the\n *     documentation and/or other materials provided with the distribution.\n * 3.  Neither the name of Apple Computer, Inc. (\"Apple\") nor the names of\n *     its contributors may be used to endorse or promote products derived\n *     from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED \"AS IS\" AND ANY\n * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF\n * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport * as Common from '../../core/common/common.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as ProtocolProxyApi from '../../generated/protocol-proxy-api.js';\nimport type * as Protocol from '../../generated/protocol.js';\n\nexport class AsyncStorageStorage extends Common.ObjectWrapper.ObjectWrapper<AsyncStorageStorage.EventTypes> {\n  private readonly model: AsyncStorageStorageModel;\n  readonly #instanceId: string;\n\n  constructor(model: AsyncStorageStorageModel, instanceId: string) {\n    super();\n    this.model = model;\n    this.#instanceId = instanceId;\n  }\n\n  get instanceId(): string {\n    return this.#instanceId;\n  }\n\n  getItems(): Promise<Protocol.AsyncStorageStorage.Item[]|null> {\n    // Use CDP command - client will handle via registered handler / CDP 명령 사용 - 클라이언트가 등록된 핸들러를 통해 처리\n    // Handler routes based on method name / 핸들러가 메서드 이름을 기준으로 라우팅\n    return this.model.agent.invoke_getAsyncStorageItems({instanceId: this.instanceId}).then(({entries}: {entries: Protocol.AsyncStorageStorage.Item[]|null}) => entries);\n  }\n\n  setItem(key: string, value: string): void {\n    void this.model.agent.invoke_setAsyncStorageItem({instanceId: this.instanceId, key, value});\n  }\n\n  removeItem(key: string): void {\n    void this.model.agent.invoke_removeAsyncStorageItem({instanceId: this.instanceId, key});\n  }\n\n  clear(): void {\n    void this.model.agent.invoke_clear({instanceId: this.instanceId});\n  }\n}\n\nexport namespace AsyncStorageStorage {\n  export const enum Events {\n    ASYNC_STORAGE_ITEMS_CLEARED = 'AsyncStorageItemsCleared',\n    ASYNC_STORAGE_ITEM_REMOVED = 'AsyncStorageItemRemoved',\n    ASYNC_STORAGE_ITEM_ADDED = 'AsyncStorageItemAdded',\n    ASYNC_STORAGE_ITEM_UPDATED = 'AsyncStorageItemUpdated',\n  }\n\n  export interface AsyncStorageItemRemovedEvent {\n    key: string;\n  }\n\n  export interface AsyncStorageItemAddedEvent {\n    key: string;\n    value: string;\n  }\n\n  export interface AsyncStorageItemUpdatedEvent {\n    key: string;\n    oldValue: string;\n    value: string;\n  }\n\n  export interface EventTypes {\n    [Events.ASYNC_STORAGE_ITEMS_CLEARED]: void;\n    [Events.ASYNC_STORAGE_ITEM_REMOVED]: AsyncStorageItemRemovedEvent;\n    [Events.ASYNC_STORAGE_ITEM_ADDED]: AsyncStorageItemAddedEvent;\n    [Events.ASYNC_STORAGE_ITEM_UPDATED]: AsyncStorageItemUpdatedEvent;\n  }\n}\n\nexport class AsyncStorageStorageModel extends SDK.SDKModel.SDKModel<EventTypes> {\n  #storages: Map<string, AsyncStorageStorage>;\n  readonly agent: ProtocolProxyApi.AsyncStorageStorageApi;\n  private enabled?: boolean;\n\n  constructor(target: SDK.Target.Target) {\n    super(target);\n\n    this.#storages = new Map();\n    this.agent = target.asyncStorageStorageAgent();\n  }\n\n  enable(): void {\n    if (this.enabled) {\n      return;\n    }\n\n    this.target().registerAsyncStorageStorageDispatcher(new AsyncStorageStorageDispatcher(this));\n    void this.agent.invoke_enable();\n\n    this.enabled = true;\n  }\n\n  asyncStorageItemsCleared({instanceId}: Protocol.AsyncStorageStorage.AsyncStorageItemsClearedEvent): void {\n    const asyncStorageStorage = this.storageForInstanceId(instanceId);\n    if (!asyncStorageStorage) {\n      return;\n    }\n\n    asyncStorageStorage.dispatchEventToListeners(AsyncStorageStorage.Events.ASYNC_STORAGE_ITEMS_CLEARED);\n  }\n\n  asyncStorageItemRemoved({instanceId, key}: Protocol.AsyncStorageStorage.AsyncStorageItemRemovedEvent): void {\n    const asyncStorageStorage = this.storageForInstanceId(instanceId);\n    if (!asyncStorageStorage) {\n      return;\n    }\n\n    const eventData = {key};\n    asyncStorageStorage.dispatchEventToListeners(AsyncStorageStorage.Events.ASYNC_STORAGE_ITEM_REMOVED, eventData);\n  }\n\n  asyncStorageItemAdded({instanceId, key, newValue}: Protocol.AsyncStorageStorage.AsyncStorageItemAddedEvent): void {\n    let asyncStorageStorage = this.storageForInstanceId(instanceId);\n    if (!asyncStorageStorage) {\n      // Create storage if it doesn't exist / 존재하지 않으면 스토리지 생성\n      asyncStorageStorage = this.addStorage(instanceId);\n    }\n\n    const eventData = {key, value: newValue};\n    asyncStorageStorage.dispatchEventToListeners(AsyncStorageStorage.Events.ASYNC_STORAGE_ITEM_ADDED, eventData);\n  }\n\n  asyncStorageItemUpdated({instanceId, key, oldValue, newValue}: Protocol.AsyncStorageStorage.AsyncStorageItemUpdatedEvent): void {\n    const asyncStorageStorage = this.storageForInstanceId(instanceId);\n    if (!asyncStorageStorage) {\n      return;\n    }\n\n    const eventData = {key, oldValue, value: newValue};\n    asyncStorageStorage.dispatchEventToListeners(AsyncStorageStorage.Events.ASYNC_STORAGE_ITEM_UPDATED, eventData);\n  }\n\n  asyncStorageInstanceCreated({instanceId}: Protocol.AsyncStorageStorage.AsyncStorageInstanceCreatedEvent): void {\n    // Create storage for new instance / 새 인스턴스에 대한 스토리지 생성\n    this.addStorage(instanceId);\n  }\n\n  private addStorage(instanceId: string): AsyncStorageStorage {\n    const existing = this.#storages.get(instanceId);\n    if (existing) {\n      return existing;\n    }\n\n    const storage = new AsyncStorageStorage(this, instanceId);\n    this.#storages.set(instanceId, storage);\n    this.dispatchEventToListeners(Events.ASYNC_STORAGE_ADDED, storage);\n    return storage;\n  }\n\n  private storageForInstanceId(instanceId: string): AsyncStorageStorage|null {\n    return this.#storages.get(instanceId) || null;\n  }\n\n  storages(): AsyncStorageStorage[] {\n    return Array.from(this.#storages.values());\n  }\n}\n\nSDK.SDKModel.SDKModel.register(AsyncStorageStorageModel, {capabilities: SDK.Target.Capability.NONE, autostart: false});\n\nexport const enum Events {\n  ASYNC_STORAGE_ADDED = 'AsyncStorageStorageAdded',\n  ASYNC_STORAGE_REMOVED = 'AsyncStorageStorageRemoved',\n}\n\nexport interface EventTypes {\n  [Events.ASYNC_STORAGE_ADDED]: AsyncStorageStorage;\n  [Events.ASYNC_STORAGE_REMOVED]: AsyncStorageStorage;\n}\n\nexport class AsyncStorageStorageDispatcher implements ProtocolProxyApi.AsyncStorageStorageDispatcher {\n  private readonly model: AsyncStorageStorageModel;\n  constructor(model: AsyncStorageStorageModel) {\n    this.model = model;\n  }\n\n  asyncStorageItemsCleared({instanceId}: Protocol.AsyncStorageStorage.AsyncStorageItemsClearedEvent): void {\n    this.model.asyncStorageItemsCleared({instanceId});\n  }\n\n  asyncStorageItemRemoved({instanceId, key}: Protocol.AsyncStorageStorage.AsyncStorageItemRemovedEvent): void {\n    this.model.asyncStorageItemRemoved({instanceId, key});\n  }\n\n  asyncStorageItemAdded({instanceId, key, newValue}: Protocol.AsyncStorageStorage.AsyncStorageItemAddedEvent): void {\n    this.model.asyncStorageItemAdded({instanceId, key, newValue});\n  }\n\n  asyncStorageItemUpdated({instanceId, key, oldValue, newValue}: Protocol.AsyncStorageStorage.AsyncStorageItemUpdatedEvent): void {\n    this.model.asyncStorageItemUpdated({instanceId, key, oldValue, newValue});\n  }\n\n  asyncStorageInstanceCreated({instanceId}: Protocol.AsyncStorageStorage.AsyncStorageInstanceCreatedEvent): void {\n    this.model.asyncStorageInstanceCreated({instanceId});\n  }\n}\n"]}
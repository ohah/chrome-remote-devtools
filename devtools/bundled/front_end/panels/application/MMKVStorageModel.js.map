{"version":3,"file":"MMKVStorageModel.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/MMKVStorageModel.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B;;;;;;;;;;;;;;;;;;;;;;;;;;;GA2BG;AAEH,OAAO,KAAK,MAAM,MAAM,6BAA6B,CAAC;AACtD,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAI7C,MAAM,OAAO,WAAY,SAAQ,MAAM,CAAC,aAAa,CAAC,aAAqC;IACxE,KAAK,CAAmB;IAChC,WAAW,CAAS;IAE7B,YAAY,KAAuB,EAAE,UAAkB;QACrD,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,WAAW,GAAG,UAAU,CAAC;IAChC,CAAC;IAED,IAAI,UAAU;QACZ,OAAO,IAAI,CAAC,WAAW,CAAC;IAC1B,CAAC;IAED,QAAQ;QACN,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC;QACnC,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QAC/B,CAAC;QAED,gGAAgG;QAChG,gGAAgG;QAChG,OAAO,MAAM,CAAC,YAAY,EAAE,CAAC,eAAe,CAAC;YAC3C,UAAU,EAAE;;;;;;;;;;;;wCAYsB,IAAI,CAAC,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;OA2BhD;YACD,aAAa,EAAE,IAAI;SACpB,CAAC,CAAC,IAAI,CAAC,CAAC,QAA2C,EAAE,EAAE;YACtD,IAAI,QAAQ,CAAC,gBAAgB,EAAE,CAAC;gBAC9B,OAAO,CAAC,KAAK,CAAC,oCAAoC,EAAE,QAAQ,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;gBACpF,OAAO,IAAI,CAAC;YACd,CAAC;YAED,gDAAgD;YAChD,MAAM,SAAS,GAAG,QAAQ,CAAC,MAAM,EAAE,KAAe,CAAC;YACnD,IAAI,CAAC,SAAS,EAAE,CAAC;gBACf,OAAO,IAAI,CAAC;YACd,CAAC;YAED,IAAI,CAAC;gBACH,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;gBACrC,OAAO,MAAM,CAAC,OAAO,IAAI,IAAI,CAAC;YAChC,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,OAAO,CAAC,KAAK,CAAC,uCAAuC,EAAE,CAAC,CAAC,CAAC;gBAC1D,OAAO,IAAI,CAAC;YACd,CAAC;QACH,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,KAAY,EAAE,EAAE;YACxB,OAAO,CAAC,KAAK,CAAC,oCAAoC,EAAE,KAAK,CAAC,CAAC;YAC3D,OAAO,IAAI,CAAC;QACd,CAAC,CAAC,CAAC;IACL,CAAC;IAED,OAAO,CAAC,GAAW,EAAE,KAAa;QAChC,KAAK,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,kBAAkB,CAAC,EAAC,UAAU,EAAE,IAAI,CAAC,UAAU,EAAE,GAAG,EAAE,KAAK,EAAC,CAAC,CAAC;IACtF,CAAC;IAED,UAAU,CAAC,GAAW;QACpB,KAAK,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,qBAAqB,CAAC,EAAC,UAAU,EAAE,IAAI,CAAC,UAAU,EAAE,GAAG,EAAC,CAAC,CAAC;IAClF,CAAC;IAED,KAAK;QACH,KAAK,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,YAAY,CAAC,EAAC,UAAU,EAAE,IAAI,CAAC,UAAU,EAAC,CAAC,CAAC;IACpE,CAAC;CACF;AAiCD,MAAM,OAAO,gBAAiB,SAAQ,GAAG,CAAC,QAAQ,CAAC,QAAoB;IACrE,SAAS,CAA2B;IAC3B,KAAK,CAAkC;IACxC,OAAO,CAAW;IAE1B,YAAY,MAAyB;QACnC,KAAK,CAAC,MAAM,CAAC,CAAC;QAEd,IAAI,CAAC,SAAS,GAAG,IAAI,GAAG,EAAE,CAAC;QAC3B,IAAI,CAAC,KAAK,GAAG,MAAM,CAAC,gBAAgB,EAAE,CAAC;IACzC,CAAC;IAED,MAAM;QACJ,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,OAAO;QACT,CAAC;QAED,IAAI,CAAC,MAAM,EAAE,CAAC,6BAA6B,CAAC,IAAI,qBAAqB,CAAC,IAAI,CAAC,CAAC,CAAC;QAC7E,KAAK,IAAI,CAAC,KAAK,CAAC,aAAa,EAAE,CAAC;QAEhC,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;IACtB,CAAC;IAED,gBAAgB,CAAC,EAAC,UAAU,EAA6C;QACvE,MAAM,WAAW,GAAG,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;QAC1D,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,OAAO;QACT,CAAC;QAED,WAAW,CAAC,wBAAwB,gEAAuC,CAAC;IAC9E,CAAC;IAED,eAAe,CAAC,EAAC,UAAU,EAAE,GAAG,EAA4C;QAC1E,MAAM,WAAW,GAAG,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;QAC1D,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,OAAO;QACT,CAAC;QAED,MAAM,SAAS,GAAG,EAAC,GAAG,EAAC,CAAC;QACxB,WAAW,CAAC,wBAAwB,+DAAuC,SAAS,CAAC,CAAC;IACxF,CAAC;IAED,aAAa,CAAC,EAAC,UAAU,EAAE,GAAG,EAAE,QAAQ,EAA0C;QAChF,IAAI,WAAW,GAAG,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;QACxD,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,wDAAwD;YACxD,WAAW,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;QAC5C,CAAC;QAED,MAAM,SAAS,GAAG,EAAC,GAAG,EAAE,KAAK,EAAE,QAAQ,EAAC,CAAC;QACzC,WAAW,CAAC,wBAAwB,2DAAqC,SAAS,CAAC,CAAC;IACtF,CAAC;IAED,eAAe,CAAC,EAAC,UAAU,EAAE,GAAG,EAAE,QAAQ,EAAE,QAAQ,EAA4C;QAC9F,MAAM,WAAW,GAAG,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;QAC1D,IAAI,CAAC,WAAW,EAAE,CAAC;YACjB,OAAO;QACT,CAAC;QAED,MAAM,SAAS,GAAG,EAAC,GAAG,EAAE,QAAQ,EAAE,KAAK,EAAE,QAAQ,EAAC,CAAC;QACnD,WAAW,CAAC,wBAAwB,+DAAuC,SAAS,CAAC,CAAC;IACxF,CAAC;IAED,mBAAmB,CAAC,EAAC,UAAU,EAAgD;QAC7E,uDAAuD;QACvD,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;IAC9B,CAAC;IAEO,UAAU,CAAC,UAAkB;QACnC,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QAChD,IAAI,QAAQ,EAAE,CAAC;YACb,OAAO,QAAQ,CAAC;QAClB,CAAC;QAED,MAAM,OAAO,GAAG,IAAI,WAAW,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;QAClD,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;QACxC,IAAI,CAAC,wBAAwB,qDAA4B,OAAO,CAAC,CAAC;QAClE,OAAO,OAAO,CAAC;IACjB,CAAC;IAEO,oBAAoB,CAAC,UAAkB;QAC7C,OAAO,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,UAAU,CAAC,IAAI,IAAI,CAAC;IAChD,CAAC;IAED,QAAQ;QACN,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,CAAC;IAC7C,CAAC;CACF;AAED,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,CAAC,gBAAgB,EAAE,EAAC,YAAY,oCAA4B,EAAE,SAAS,EAAE,KAAK,EAAC,CAAC,CAAC;AAY/G,MAAM,OAAO,qBAAqB;IACf,KAAK,CAAmB;IACzC,YAAY,KAAuB;QACjC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;IACrB,CAAC;IAED,gBAAgB,CAAC,EAAC,UAAU,EAA6C;QACvE,IAAI,CAAC,KAAK,CAAC,gBAAgB,CAAC,EAAC,UAAU,EAAC,CAAC,CAAC;IAC5C,CAAC;IAED,eAAe,CAAC,EAAC,UAAU,EAAE,GAAG,EAA4C;QAC1E,IAAI,CAAC,KAAK,CAAC,eAAe,CAAC,EAAC,UAAU,EAAE,GAAG,EAAC,CAAC,CAAC;IAChD,CAAC;IAED,aAAa,CAAC,EAAC,UAAU,EAAE,GAAG,EAAE,QAAQ,EAA0C;QAChF,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,EAAC,UAAU,EAAE,GAAG,EAAE,QAAQ,EAAC,CAAC,CAAC;IACxD,CAAC;IAED,eAAe,CAAC,EAAC,UAAU,EAAE,GAAG,EAAE,QAAQ,EAAE,QAAQ,EAA4C;QAC9F,IAAI,CAAC,KAAK,CAAC,eAAe,CAAC,EAAC,UAAU,EAAE,GAAG,EAAE,QAAQ,EAAE,QAAQ,EAAC,CAAC,CAAC;IACpE,CAAC;IAED,mBAAmB,CAAC,EAAC,UAAU,EAAgD;QAC7E,IAAI,CAAC,KAAK,CAAC,mBAAmB,CAAC,EAAC,UAAU,EAAC,CAAC,CAAC;IAC/C,CAAC;CACF","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/*\n * Copyright (C) 2008 Nokia Inc.  All rights reserved.\n * Copyright (C) 2013 Samsung Electronics. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions\n * are met:\n *\n * 1.  Redistributions of source code must retain the above copyright\n *     notice, this list of conditions and the following disclaimer.\n * 2.  Redistributions in binary form must reproduce the above copyright\n *     notice, this list of conditions and the following disclaimer in the\n *     documentation and/or other materials provided with the distribution.\n * 3.  Neither the name of Apple Computer, Inc. (\"Apple\") nor the names of\n *     its contributors may be used to endorse or promote products derived\n *     from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED \"AS IS\" AND ANY\n * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF\n * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport * as Common from '../../core/common/common.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as ProtocolProxyApi from '../../generated/protocol-proxy-api.js';\nimport type * as Protocol from '../../generated/protocol.js';\n\nexport class MMKVStorage extends Common.ObjectWrapper.ObjectWrapper<MMKVStorage.EventTypes> {\n  private readonly model: MMKVStorageModel;\n  readonly #instanceId: string;\n\n  constructor(model: MMKVStorageModel, instanceId: string) {\n    super();\n    this.model = model;\n    this.#instanceId = instanceId;\n  }\n\n  get instanceId(): string {\n    return this.#instanceId;\n  }\n\n  getItems(): Promise<Protocol.MMKVStorage.Item[]|null> {\n    const target = this.model.target();\n    if (!target) {\n      return Promise.resolve(null);\n    }\n\n    // Use Runtime.evaluate to directly execute JavaScript / Runtime.evaluate를 사용하여 JavaScript 직접 실행\n    // This avoids needing native code to forward CDP commands / 이렇게 하면 네이티브 코드에서 CDP 명령을 전달할 필요가 없음\n    return target.runtimeAgent().invoke_evaluate({\n      expression: `\n        (function() {\n          // Get global object (window for web, global for React Native) / 전역 객체 가져오기 (웹은 window, React Native는 global)\n          const globalObj = typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : {};\n\n          // Access MMKV views from global / 전역에서 MMKV views 접근\n          const mmkvViews = globalObj.__MMKV_VIEWS__;\n          if (!mmkvViews) {\n            return JSON.stringify({ entries: [] });\n          }\n\n          // Get view for this instance / 이 인스턴스에 대한 view 가져오기\n          const view = mmkvViews.get('${this.instanceId}');\n          if (!view) {\n            return JSON.stringify({ entries: [] });\n          }\n\n          // Get all entries / 모든 엔트리 가져오기\n          const entries = view.getAllEntries();\n\n          // Convert to CDP format (array of [key, value] tuples) / CDP 형식으로 변환 ([key, value] 튜플 배열)\n          const cdpEntries = entries.map(entry => {\n            let valueStr;\n            if (entry.type === 'string') {\n              valueStr = entry.value;\n            } else if (entry.type === 'number') {\n              valueStr = String(entry.value);\n            } else if (entry.type === 'boolean') {\n              valueStr = String(entry.value);\n            } else {\n              // buffer is array of numbers, convert to JSON / buffer는 숫자 배열이므로 JSON으로 변환\n              valueStr = JSON.stringify(entry.value);\n            }\n            return [entry.key, valueStr];\n          });\n\n          // Return as JSON string / JSON 문자열로 반환\n          return JSON.stringify({ entries: cdpEntries });\n        })();\n      `,\n      returnByValue: true,\n    }).then((response: Protocol.Runtime.EvaluateResponse) => {\n      if (response.exceptionDetails) {\n        console.error('[MMKVStorage] Error getting items:', response.exceptionDetails.text);\n        return null;\n      }\n\n      // Parse the JSON string result / JSON 문자열 결과 파싱\n      const resultStr = response.result?.value as string;\n      if (!resultStr) {\n        return null;\n      }\n\n      try {\n        const result = JSON.parse(resultStr);\n        return result.entries || null;\n      } catch (e) {\n        console.error('[MMKVStorage] Failed to parse result:', e);\n        return null;\n      }\n    }).catch((error: Error) => {\n      console.error('[MMKVStorage] Failed to get items:', error);\n      return null;\n    });\n  }\n\n  setItem(key: string, value: string): void {\n    void this.model.agent.invoke_setMMKVItem({instanceId: this.instanceId, key, value});\n  }\n\n  removeItem(key: string): void {\n    void this.model.agent.invoke_removeMMKVItem({instanceId: this.instanceId, key});\n  }\n\n  clear(): void {\n    void this.model.agent.invoke_clear({instanceId: this.instanceId});\n  }\n}\n\nexport namespace MMKVStorage {\n  export const enum Events {\n    MMKV_ITEMS_CLEARED = 'MMKVItemsCleared',\n    MMKV_ITEM_REMOVED = 'MMKVItemRemoved',\n    MMKV_ITEM_ADDED = 'MMKVItemAdded',\n    MMKV_ITEM_UPDATED = 'MMKVItemUpdated',\n  }\n\n  export interface MmkvItemRemovedEvent {\n    key: string;\n  }\n\n  export interface MmkvItemAddedEvent {\n    key: string;\n    value: string;\n  }\n\n  export interface MmkvItemUpdatedEvent {\n    key: string;\n    oldValue: string;\n    value: string;\n  }\n\n  export interface EventTypes {\n    [Events.MMKV_ITEMS_CLEARED]: void;\n    [Events.MMKV_ITEM_REMOVED]: MmkvItemRemovedEvent;\n    [Events.MMKV_ITEM_ADDED]: MmkvItemAddedEvent;\n    [Events.MMKV_ITEM_UPDATED]: MmkvItemUpdatedEvent;\n  }\n}\n\nexport class MMKVStorageModel extends SDK.SDKModel.SDKModel<EventTypes> {\n  #storages: Map<string, MMKVStorage>;\n  readonly agent: ProtocolProxyApi.MMKVStorageApi;\n  private enabled?: boolean;\n\n  constructor(target: SDK.Target.Target) {\n    super(target);\n\n    this.#storages = new Map();\n    this.agent = target.mmkvStorageAgent();\n  }\n\n  enable(): void {\n    if (this.enabled) {\n      return;\n    }\n\n    this.target().registerMMKVStorageDispatcher(new MMKVStorageDispatcher(this));\n    void this.agent.invoke_enable();\n\n    this.enabled = true;\n  }\n\n  mmkvItemsCleared({instanceId}: Protocol.MMKVStorage.MmkvItemsClearedEvent): void {\n    const mmkvStorage = this.storageForInstanceId(instanceId);\n    if (!mmkvStorage) {\n      return;\n    }\n\n    mmkvStorage.dispatchEventToListeners(MMKVStorage.Events.MMKV_ITEMS_CLEARED);\n  }\n\n  mmkvItemRemoved({instanceId, key}: Protocol.MMKVStorage.MmkvItemRemovedEvent): void {\n    const mmkvStorage = this.storageForInstanceId(instanceId);\n    if (!mmkvStorage) {\n      return;\n    }\n\n    const eventData = {key};\n    mmkvStorage.dispatchEventToListeners(MMKVStorage.Events.MMKV_ITEM_REMOVED, eventData);\n  }\n\n  mmkvItemAdded({instanceId, key, newValue}: Protocol.MMKVStorage.MmkvItemAddedEvent): void {\n    let mmkvStorage = this.storageForInstanceId(instanceId);\n    if (!mmkvStorage) {\n      // Create storage if it doesn't exist / 존재하지 않으면 스토리지 생성\n      mmkvStorage = this.addStorage(instanceId);\n    }\n\n    const eventData = {key, value: newValue};\n    mmkvStorage.dispatchEventToListeners(MMKVStorage.Events.MMKV_ITEM_ADDED, eventData);\n  }\n\n  mmkvItemUpdated({instanceId, key, oldValue, newValue}: Protocol.MMKVStorage.MmkvItemUpdatedEvent): void {\n    const mmkvStorage = this.storageForInstanceId(instanceId);\n    if (!mmkvStorage) {\n      return;\n    }\n\n    const eventData = {key, oldValue, value: newValue};\n    mmkvStorage.dispatchEventToListeners(MMKVStorage.Events.MMKV_ITEM_UPDATED, eventData);\n  }\n\n  mmkvInstanceCreated({instanceId}: Protocol.MMKVStorage.MmkvInstanceCreatedEvent): void {\n    // Create storage for new instance / 새 인스턴스에 대한 스토리지 생성\n    this.addStorage(instanceId);\n  }\n\n  private addStorage(instanceId: string): MMKVStorage {\n    const existing = this.#storages.get(instanceId);\n    if (existing) {\n      return existing;\n    }\n\n    const storage = new MMKVStorage(this, instanceId);\n    this.#storages.set(instanceId, storage);\n    this.dispatchEventToListeners(Events.MMKV_STORAGE_ADDED, storage);\n    return storage;\n  }\n\n  private storageForInstanceId(instanceId: string): MMKVStorage|null {\n    return this.#storages.get(instanceId) || null;\n  }\n\n  storages(): MMKVStorage[] {\n    return Array.from(this.#storages.values());\n  }\n}\n\nSDK.SDKModel.SDKModel.register(MMKVStorageModel, {capabilities: SDK.Target.Capability.NONE, autostart: false});\n\nexport const enum Events {\n  MMKV_STORAGE_ADDED = 'MMKVStorageAdded',\n  MMKV_STORAGE_REMOVED = 'MMKVStorageRemoved',\n}\n\nexport interface EventTypes {\n  [Events.MMKV_STORAGE_ADDED]: MMKVStorage;\n  [Events.MMKV_STORAGE_REMOVED]: MMKVStorage;\n}\n\nexport class MMKVStorageDispatcher implements ProtocolProxyApi.MMKVStorageDispatcher {\n  private readonly model: MMKVStorageModel;\n  constructor(model: MMKVStorageModel) {\n    this.model = model;\n  }\n\n  mmkvItemsCleared({instanceId}: Protocol.MMKVStorage.MmkvItemsClearedEvent): void {\n    this.model.mmkvItemsCleared({instanceId});\n  }\n\n  mmkvItemRemoved({instanceId, key}: Protocol.MMKVStorage.MmkvItemRemovedEvent): void {\n    this.model.mmkvItemRemoved({instanceId, key});\n  }\n\n  mmkvItemAdded({instanceId, key, newValue}: Protocol.MMKVStorage.MmkvItemAddedEvent): void {\n    this.model.mmkvItemAdded({instanceId, key, newValue});\n  }\n\n  mmkvItemUpdated({instanceId, key, oldValue, newValue}: Protocol.MMKVStorage.MmkvItemUpdatedEvent): void {\n    this.model.mmkvItemUpdated({instanceId, key, oldValue, newValue});\n  }\n\n  mmkvInstanceCreated({instanceId}: Protocol.MMKVStorage.MmkvInstanceCreatedEvent): void {\n    this.model.mmkvInstanceCreated({instanceId});\n  }\n}\n"]}
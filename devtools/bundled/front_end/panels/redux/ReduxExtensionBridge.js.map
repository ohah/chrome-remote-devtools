{"version":3,"file":"ReduxExtensionBridge.js","sourceRoot":"","sources":["../../../../../../front_end/panels/redux/ReduxExtensionBridge.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAG7B,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAG7C;;;GAGG;AACH,MAAM,OAAO,oBAAoB;IACvB,YAAY,GAAkB,IAAI,CAAC;IACnC,MAAM,GAA6B,IAAI,CAAC;IACxC,QAAQ,GAA8D,IAAI,CAAC;IAC3E,WAAW,GAAuB,IAAI,CAAC;IACvC,gBAAgB,GAAkC,EAAE,CAAC;IAE7D;;OAEG;IACH,UAAU,CAAC,YAAoB;QAC7B,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,kBAAkB,EAAE,CAAC;IAC5B,CAAC;IAED;;OAEG;IACK,kBAAkB;QACxB,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC;YAAA,OAAO;QAAA,CAAC;QAEjC,oFAAoF;QACpF,MAAM,OAAO,GAAG,IAAI,cAAc,EAAE,CAAC;QACrC,IAAI,CAAC,WAAW,GAAG,OAAO,CAAC,KAAK,CAAC;QAEjC,4CAA4C;QAC5C,IAAI,CAAC,WAAW,CAAC,SAAS,GAAG,KAAK,CAAC,EAAE;YACnC,IAAI,CAAC,sBAAsB,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QAC1C,CAAC,CAAC;QAEF,oHAAoH;QACnH,IAAI,CAAC,YAAoB,CAAC,MAAM,GAAG;YAClC,OAAO,EAAE;gBACP,uDAAuD;gBACvD,OAAO,EAAE,CAAC,OAA2B,EAAE,EAAE;oBACvC,sFAAsF;oBACtF,OAAO,IAAI,CAAC,WAAW,CAAC;gBAC1B,CAAC;gBACD,gEAAgE;gBAChE,WAAW,EAAE,CAAC,OAAY,EAAE,QAAkC,EAAE,EAAE;oBAChE,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC,CAAC;oBACrC,IAAI,QAAQ,EAAE,CAAC;wBACb,QAAQ,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC;oBAC9B,CAAC;gBACH,CAAC;gBACD,0EAA0E;gBAC1E,SAAS,EAAE;oBACT,WAAW,EAAE,CAAC,QAAgC,EAAE,EAAE;wBAChD,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;oBACvC,CAAC;oBACD,cAAc,EAAE,CAAC,QAAgC,EAAE,EAAE;wBACnD,MAAM,KAAK,GAAG,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;wBACtD,IAAI,KAAK,GAAG,CAAC,CAAC,EAAE,CAAC;4BACf,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;wBACzC,CAAC;oBACH,CAAC;iBACF;gBACD,0DAA0D;gBAC1D,MAAM,EAAE,CAAC,IAAY,EAAE,EAAE;oBACvB,OAAO,sDAAsD,IAAI,EAAE,CAAC;gBACtE,CAAC;aACF;YACD,QAAQ,EAAE;gBACR,eAAe,EAAE;oBACf,+DAA+D;oBAC/D,IAAI,EAAE,CAAC,UAAkB,EAAE,QAAqD,EAAE,EAAE;wBAClF,IAAI,CAAC,uBAAuB,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;oBACrD,CAAC;oBACD,+DAA+D;oBAC/D,YAAY,EAAE,CAAC,QAAoD,EAAE,EAAE;wBACrE,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC;oBAClC,CAAC;oBACD,gEAAgE;oBAChE,IAAI,KAAK;wBACP,OAAO,SAAS,CAAC;oBACnB,CAAC;iBACF;aACF;SACF,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,sBAAsB,CAAC,OAAY;QACzC,wEAAwE;QACxE,gEAAgE;QAChE,OAAO,CAAC,GAAG,CAAC,yDAAyD,EAAE,OAAO,CAAC,CAAC;IAClF,CAAC;IAED;;OAEG;IACK,eAAe,CAAC,OAAY;QAClC,IAAI,CAAC,IAAI,CAAC,YAAY,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;YAAA,OAAO;QAAA,CAAC;QAEtD,4CAA4C;QAC5C,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;QAEtC,gDAAgD;QAChD,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;IAC9C,CAAC;IAED;;OAEG;IACH,cAAc,CAAC,MAAyB,EAAE,UAAsD;QAC9F,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QAErB,IAAI,CAAC,QAAQ,GAAG;YACd,OAAO,EAAE,CACP,KAAgF,EAC1E,EAAE;gBACR,oGAAoG;gBACpG,MAAM,MAAM,GAAG,KAAK,CAAC,MAAgB,CAAC;gBACtC,IAAI,MAAM,KAAK,YAAY;oBACvB,MAAM,KAAK,wBAAwB;oBACnC,MAAM,KAAK,aAAa,EAAE,CAAC;oBAC7B,IAAI,CAAC,4BAA4B,CAAC,KAAK,CAAC,CAAC;gBAC3C,CAAC;YACH,CAAC;YACD,YAAY,EAAE,CAAC,OAAe,EAAQ,EAAE;gBACtC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;YACvB,CAAC;SACF,CAAC;QAEF,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IACpC,CAAC;IAED;;OAEG;IACK,4BAA4B,CAAC,KAAiD;QACpF,MAAM,MAAM,GAAG,KAAK,CAAC,MAAa,CAAC;QAEnC,0FAA0F;QAC1F,MAAM,gBAAgB,GAAG;YACvB,IAAI,EAAE,eAAe;YACrB,MAAM,EAAE,KAAK,CAAC,MAAM;YACpB,MAAM;YACN,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB,CAAC;QAEF,IAAI,CAAC,eAAe,CAAC,gBAAgB,CAAC,CAAC;IACzC,CAAC;IAED;;OAEG;IACK,uBAAuB,CAC7B,UAAkB,EAClB,QAAqD;QAErD,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,QAAQ,EAAE,CAAC;gBAAA,QAAQ,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,IAAI,EAAE,KAAK,EAAE,qBAAqB,EAAE,CAAC,CAAC;YAAA,CAAC;YACpF,OAAO;QACT,CAAC;QAED,MAAM,YAAY,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC;QACtE,IAAI,CAAC,YAAY,EAAE,CAAC;YAClB,IAAI,QAAQ,EAAE,CAAC;gBAAA,QAAQ,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,IAAI,EAAE,KAAK,EAAE,4BAA4B,EAAE,CAAC,CAAC;YAAA,CAAC;YAC3F,OAAO;QACT,CAAC;QAED,+CAA+C;QAC/C,IAAI,CAAC,MAAM,CAAC,YAAY,EAAE,CAAC,eAAe,CAAC;YACzC,UAAU;YACV,aAAa,EAAE,IAAI;SACpB,CAAC,CAAC,IAAI,CAAC,CAAC,QAA2C,EAAE,EAAE;YACtD,IAAI,QAAQ,EAAE,CAAC;gBACb,IAAI,QAAQ,CAAC,gBAAgB,EAAE,CAAC;oBAC9B,QAAQ,CAAC,IAAI,EAAE;wBACb,WAAW,EAAE,IAAI;wBACjB,KAAK,EAAE,QAAQ,CAAC,gBAAgB,CAAC,IAAI,IAAI,eAAe;qBACzD,CAAC,CAAC;gBACL,CAAC;qBAAM,CAAC;oBACN,QAAQ,CAAC,QAAQ,CAAC,MAAM,EAAE,KAAK,EAAE,SAAS,CAAC,CAAC;gBAC9C,CAAC;YACH,CAAC;QACH,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,KAAY,EAAE,EAAE;YACxB,IAAI,QAAQ,EAAE,CAAC;gBAAA,QAAQ,CAAC,IAAI,EAAE,EAAE,WAAW,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;YAAA,CAAC;QAC9E,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACK,gBAAgB,CAAC,QAAoD;QAC3E,qEAAqE;QACrE,MAAM,SAAS,GAAyB,EAAE,CAAC;QAE3C,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;YACjB,kEAAkE;YAClE,IAAI,QAAQ,EAAE,CAAC;gBACb,QAAQ,CAAC,CAAC,EAAC,GAAG,EAAE,aAAa,EAAC,CAAC,CAAC,CAAC;YACnC,CAAC;YACD,OAAO;QACT,CAAC;QAED,yEAAyE;QACzE,MAAM,YAAY,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,EAAE,CAAC;QAChD,IAAI,YAAY,EAAE,CAAC;YACjB,SAAS,CAAC,IAAI,CAAC,EAAC,GAAG,EAAE,YAAY,EAAC,CAAC,CAAC;QACtC,CAAC;QAED,MAAM,iBAAiB,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;QACrF,IAAI,iBAAiB,EAAE,SAAS,EAAE,CAAC;YACjC,0FAA0F;YAC1F,MAAM,YAAY,GAAG,iBAAiB,CAAC,SAAS,CAAC,GAAG,CAAC;YACrD,IAAI,YAAY,IAAI,YAAY,KAAK,YAAY,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,YAAY,CAAC,EAAE,CAAC;gBAClG,SAAS,CAAC,IAAI,CAAC,EAAC,GAAG,EAAE,YAAY,EAAC,CAAC,CAAC;YACtC,CAAC;YAED,8DAA8D;YAC9D,iBAAiB,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE;gBACzD,MAAM,GAAG,GAAG,QAAQ,CAAC,GAAG,CAAC;gBACzB,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,GAAG,CAAC,EAAE,CAAC;oBAC/C,SAAS,CAAC,IAAI,CAAC,EAAC,GAAG,EAAC,CAAC,CAAC;gBACxB,CAAC;YACH,CAAC,CAAC,CAAC;QACL,CAAC;QAED,6DAA6D;QAC7D,IAAI,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC3B,SAAS,CAAC,IAAI,CAAC,EAAC,GAAG,EAAE,YAAY,IAAI,aAAa,EAAC,CAAC,CAAC;QACvD,CAAC;QAED,IAAI,QAAQ,EAAE,CAAC;YACb,QAAQ,CAAC,SAAS,CAAC,CAAC;QACtB,CAAC;IACH,CAAC;IAED;;OAEG;IACH,OAAO;QACL,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YACjC,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC;YACpC,IAAI,MAAM,EAAE,UAAU,EAAE,CAAC;gBACvB,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YAC7C,CAAC;YACD,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QACvB,CAAC;QACD,IAAI,CAAC,gBAAgB,GAAG,EAAE,CAAC;IAC7B,CAAC;CACF","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as ProtocolClient from '../../core/protocol_client/protocol_client.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Protocol from '../../generated/protocol.js';\n\n/**\n * Redux DevTools Extension과의 통신 브릿지 / Redux DevTools Extension과의 통신 브릿지\n * Extension의 chrome.runtime API를 시뮬레이션하고 CDP 메시지를 Extension 형식으로 변환 / Extension의 chrome.runtime API를 시뮬레이션하고 CDP 메시지를 Extension 형식으로 변환\n */\nexport class ReduxExtensionBridge {\n  private iframeWindow: Window | null = null;\n  private target: SDK.Target.Target | null = null;\n  private observer: ProtocolClient.CDPConnection.CDPConnectionObserver | null = null;\n  private messagePort: MessagePort | null = null;\n  private messageListeners: Array<(message: any) => void> = [];\n\n  /**\n   * Initialize bridge with iframe window / iframe window로 브릿지 초기화\n   */\n  initialize(iframeWindow: Window): void {\n    this.iframeWindow = iframeWindow;\n    this.injectExtensionAPI();\n  }\n\n  /**\n   * Inject chrome.runtime API into iframe / iframe에 chrome.runtime API 주입\n   */\n  private injectExtensionAPI(): void {\n    if (!this.iframeWindow) {return;}\n\n    // MessageChannel을 사용하여 가상의 MessagePort 생성 / MessageChannel을 사용하여 가상의 MessagePort 생성\n    const channel = new MessageChannel();\n    this.messagePort = channel.port1;\n\n    // MessagePort로 메시지 수신 / MessagePort로 메시지 수신\n    this.messagePort.onmessage = event => {\n      this.handleExtensionMessage(event.data);\n    };\n\n    // Redux DevTools Extension이 사용하는 chrome.runtime API 시뮬레이션 / Redux DevTools Extension이 사용하는 chrome.runtime API 시뮬레이션\n    (this.iframeWindow as any).chrome = {\n      runtime: {\n        // Connect to background script / background script에 연결\n        connect: (options?: { name?: string }) => {\n          // MessagePort를 반환하여 Extension이 통신할 수 있도록 함 / MessagePort를 반환하여 Extension이 통신할 수 있도록 함\n          return this.messagePort;\n        },\n        // Send message to background script / background script로 메시지 전송\n        sendMessage: (message: any, callback?: (response: any) => void) => {\n          this.handleExtensionMessage(message);\n          if (callback) {\n            callback({ success: true });\n          }\n        },\n        // Listen to messages from background script / background script로부터 메시지 수신\n        onMessage: {\n          addListener: (callback: (message: any) => void) => {\n            this.messageListeners.push(callback);\n          },\n          removeListener: (callback: (message: any) => void) => {\n            const index = this.messageListeners.indexOf(callback);\n            if (index > -1) {\n              this.messageListeners.splice(index, 1);\n            }\n          },\n        },\n        // Get URL for extension resource / extension 리소스 URL 가져오기\n        getURL: (path: string) => {\n          return `devtools://devtools/bundled/panels/redux/extension/${path}`;\n        },\n      },\n      devtools: {\n        inspectedWindow: {\n          // Evaluate script in inspected page / inspected page에서 스크립트 실행\n          eval: (expression: string, callback?: (result: any, exceptionInfo?: any) => void) => {\n            this.evaluateInInspectedPage(expression, callback);\n          },\n          // Get resources from inspected page / inspected page의 리소스 가져오기\n          getResources: (callback?: (resources: Array<{url: string}>) => void) => {\n            this.getPageResources(callback);\n          },\n          // Tab ID (not used in this context) / Tab ID (이 컨텍스트에서 사용되지 않음)\n          get tabId() {\n            return undefined;\n          },\n        },\n      },\n    };\n  }\n\n  /**\n   * Handle messages from Redux DevTools Extension / Redux DevTools Extension으로부터 메시지 처리\n   */\n  private handleExtensionMessage(message: any): void {\n    // Redux DevTools Extension의 메시지를 처리 / Redux DevTools Extension의 메시지를 처리\n    // 여기서는 CDP 메시지로 변환하거나 필요한 작업 수행 / 여기서는 CDP 메시지로 변환하거나 필요한 작업 수행\n    console.log('[ReduxExtensionBridge] Received message from extension:', message);\n  }\n\n  /**\n   * Send message to Redux DevTools Extension iframe / Redux DevTools Extension iframe으로 메시지 전송\n   */\n  private sendToExtension(message: any): void {\n    if (!this.iframeWindow || !this.messagePort) {return;}\n\n    // MessagePort로 메시지 전송 / MessagePort로 메시지 전송\n    this.messagePort.postMessage(message);\n\n    // 또는 postMessage로 직접 전송 / 또는 postMessage로 직접 전송\n    this.iframeWindow.postMessage(message, '*');\n  }\n\n  /**\n   * Attach to target and listen for Redux CDP events / 타겟에 연결하고 Redux CDP 이벤트 리스닝\n   */\n  attachToTarget(target: SDK.Target.Target, connection: ProtocolClient.CDPConnection.CDPConnection): void {\n    this.target = target;\n\n    this.observer = {\n      onEvent: (\n        event: ProtocolClient.CDPConnection.CDPEvent<ProtocolClient.CDPConnection.Event>\n      ): void => {\n        // Redux CDP 이벤트를 Redux DevTools Extension 형식으로 변환 / Redux CDP 이벤트를 Redux DevTools Extension 형식으로 변환\n        const method = event.method as string;\n        if (method === 'Redux.init' ||\n            method === 'Redux.actionDispatched' ||\n            method === 'Redux.error') {\n          this.convertCDPToExtensionMessage(event);\n        }\n      },\n      onDisconnect: (_reason: string): void => {\n        this.observer = null;\n      },\n    };\n\n    connection.observe(this.observer);\n  }\n\n  /**\n   * Convert CDP message to Extension message format / CDP 메시지를 Extension 메시지 형식으로 변환\n   */\n  private convertCDPToExtensionMessage(event: ProtocolClient.CDPConnection.CDPEvent<any>): void {\n    const params = event.params as any;\n\n    // Redux DevTools Extension이 기대하는 메시지 형식으로 변환 / Redux DevTools Extension이 기대하는 메시지 형식으로 변환\n    const extensionMessage = {\n      type: 'REDUX_MESSAGE',\n      method: event.method,\n      params,\n      timestamp: Date.now(),\n    };\n\n    this.sendToExtension(extensionMessage);\n  }\n\n  /**\n   * Evaluate script in inspected page / inspected page에서 스크립트 실행\n   */\n  private evaluateInInspectedPage(\n    expression: string,\n    callback?: (result: any, exceptionInfo?: any) => void\n  ): void {\n    if (!this.target) {\n      if (callback) {callback(null, { isException: true, value: 'No target available' });}\n      return;\n    }\n\n    const runtimeModel = this.target.model(SDK.RuntimeModel.RuntimeModel);\n    if (!runtimeModel) {\n      if (callback) {callback(null, { isException: true, value: 'No runtime model available' });}\n      return;\n    }\n\n    // Use Runtime API directly / Runtime API 직접 사용\n    this.target.runtimeAgent().invoke_evaluate({\n      expression,\n      returnByValue: true,\n    }).then((response: Protocol.Runtime.EvaluateResponse) => {\n      if (callback) {\n        if (response.exceptionDetails) {\n          callback(null, {\n            isException: true,\n            value: response.exceptionDetails.text || 'Unknown error',\n          });\n        } else {\n          callback(response.result?.value, undefined);\n        }\n      }\n    }).catch((error: Error) => {\n      if (callback) {callback(null, { isException: true, value: error.message });}\n    });\n  }\n\n  /**\n   * Get page resources / 페이지 리소스 가져오기\n   */\n  private getPageResources(callback?: (resources: Array<{url: string}>) => void): void {\n    // Always return at least the current page URL / 항상 최소한 현재 페이지 URL 반환\n    const resources: Array<{url: string}> = [];\n\n    if (!this.target) {\n      // Fallback: use about:blank if no target / 타겟이 없으면 about:blank 사용\n      if (callback) {\n        callback([{url: 'about:blank'}]);\n      }\n      return;\n    }\n\n    // Get inspected URL (current page URL) / inspected URL 가져오기 (현재 페이지 URL)\n    const inspectedUrl = this.target.inspectedURL();\n    if (inspectedUrl) {\n      resources.push({url: inspectedUrl});\n    }\n\n    const resourceTreeModel = this.target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    if (resourceTreeModel?.mainFrame) {\n      // Get main frame URL if different from inspected URL / inspected URL과 다르면 메인 프레임 URL 가져오기\n      const mainFrameUrl = resourceTreeModel.mainFrame.url;\n      if (mainFrameUrl && mainFrameUrl !== inspectedUrl && !resources.some(r => r.url === mainFrameUrl)) {\n        resources.push({url: mainFrameUrl});\n      }\n\n      // Get all resources from the main frame / 메인 프레임의 모든 리소스 가져오기\n      resourceTreeModel.mainFrame.resources().forEach(resource => {\n        const url = resource.url;\n        if (url && !resources.some(r => r.url === url)) {\n          resources.push({url});\n        }\n      });\n    }\n\n    // Ensure at least one resource is returned / 최소한 하나의 리소스는 반환\n    if (resources.length === 0) {\n      resources.push({url: inspectedUrl || 'about:blank'});\n    }\n\n    if (callback) {\n      callback(resources);\n    }\n  }\n\n  /**\n   * Cleanup / 정리\n   */\n  cleanup(): void {\n    if (this.observer && this.target) {\n      const router = this.target.router();\n      if (router?.connection) {\n        router.connection.unobserve(this.observer);\n      }\n      this.observer = null;\n    }\n    this.messageListeners = [];\n  }\n}\n\n"]}